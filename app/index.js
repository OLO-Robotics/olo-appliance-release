const a1_0x29ee9d=a1_0x3c95;(function(_0xd60d86,_0x361ec6){const _0x41410e=a1_0x3c95,_0x95b743=_0xd60d86();while(!![]){try{const _0x559c12=parseInt(_0x41410e(0xab))/0x1+parseInt(_0x41410e(0x83))/0x2*(-parseInt(_0x41410e(0xd7))/0x3)+parseInt(_0x41410e(0xe2))/0x4+-parseInt(_0x41410e(0xd5))/0x5*(-parseInt(_0x41410e(0xe9))/0x6)+-parseInt(_0x41410e(0x6e))/0x7+parseInt(_0x41410e(0x110))/0x8+-parseInt(_0x41410e(0xf5))/0x9;if(_0x559c12===_0x361ec6)break;else _0x95b743['push'](_0x95b743['shift']());}catch(_0x4f2fdc){_0x95b743['push'](_0x95b743['shift']());}}}(a1_0x5692,0xd4492));const a1_0x4d5fc8=(function(){let _0xd179f=!![];return function(_0x347732,_0x1abffa){const _0x517d8a=_0xd179f?function(){const _0x4e23fa=a1_0x3c95;if(_0x1abffa){const _0x282e07=_0x1abffa[_0x4e23fa(0xfb)](_0x347732,arguments);return _0x1abffa=null,_0x282e07;}}:function(){};return _0xd179f=![],_0x517d8a;};}()),a1_0x2435c6=a1_0x4d5fc8(this,function(){const _0x7668a4=a1_0x3c95;return a1_0x2435c6[_0x7668a4(0xb7)]()[_0x7668a4(0xf9)](_0x7668a4(0x131))[_0x7668a4(0xb7)]()[_0x7668a4(0xdc)](a1_0x2435c6)[_0x7668a4(0xf9)](_0x7668a4(0x131));});a1_0x2435c6();const dotenv=require(a1_0x29ee9d(0x99));dotenv[a1_0x29ee9d(0xec)]();const express=require(a1_0x29ee9d(0x126)),config=require(a1_0x29ee9d(0xa8));process[a1_0x29ee9d(0xe0)][a1_0x29ee9d(0x130)]&&process[a1_0x29ee9d(0xe0)][a1_0x29ee9d(0x124)]&&(config['credentials'][a1_0x29ee9d(0xa7)]=process['env']['APP_USERNAME'],config[a1_0x29ee9d(0xb5)]['password']=process[a1_0x29ee9d(0xe0)][a1_0x29ee9d(0x124)],console[a1_0x29ee9d(0x76)](a1_0x29ee9d(0xea)));const authService=require(a1_0x29ee9d(0xaf)),webrtcService=require(a1_0x29ee9d(0x106)),topicManager=require('./services/TopicManager'),WebSocket=require('ws'),axios=require(a1_0x29ee9d(0xb6)),fs=require('fs'),prompt=require(a1_0x29ee9d(0xf0))({'sigint':!![]}),app=express(),port=process[a1_0x29ee9d(0xe0)][a1_0x29ee9d(0x9e)]||config['rosbridge'][a1_0x29ee9d(0x123)],APPLIANCE_FILE=a1_0x29ee9d(0x9b),{DOMParser,XMLSerializer}=require(a1_0x29ee9d(0x103)),path=require(a1_0x29ee9d(0x7c)),{execSync}=require(a1_0x29ee9d(0x12b)),APPLIANCE_BASE_URL=process[a1_0x29ee9d(0xe0)][a1_0x29ee9d(0xd2)]||'';console[a1_0x29ee9d(0x76)](a1_0x29ee9d(0xcc)+(process['env'][a1_0x29ee9d(0xb4)]||'development')),console[a1_0x29ee9d(0x76)](a1_0x29ee9d(0xb8)+config[a1_0x29ee9d(0x97)]),console[a1_0x29ee9d(0x76)](a1_0x29ee9d(0x128)+config[a1_0x29ee9d(0xdf)][a1_0x29ee9d(0x74)]),console[a1_0x29ee9d(0x76)](a1_0x29ee9d(0x125)+port);let serverWs=null,rosbridgeWs=null,rosbridgeWebRTCWs=null,registrationToken=null,robotId=null;function updateEnvFile(_0x163b86,_0x39c75b){const _0x21d4e8=a1_0x29ee9d;fs[_0x21d4e8(0x7b)](_0x21d4e8(0xe4),'APP_USERNAME='+_0x163b86+_0x21d4e8(0x7f)+_0x39c75b+'\x0a');}function reloadEnv(){const _0xb8ee0c=a1_0x29ee9d;dotenv['config']({'override':!![]}),config[_0xb8ee0c(0xb5)][_0xb8ee0c(0xa7)]=process['env'][_0xb8ee0c(0x130)],config['credentials'][_0xb8ee0c(0x115)]=process[_0xb8ee0c(0xe0)][_0xb8ee0c(0x124)],console['log'](_0xb8ee0c(0xa9),{'username':config['credentials']['username']?_0xb8ee0c(0x11a):'NOT\x20SET','password':config[_0xb8ee0c(0xb5)][_0xb8ee0c(0x115)]?_0xb8ee0c(0x11a):_0xb8ee0c(0xbe)});}function a1_0x5692(){const _0x41ae6b=['APP_PASSWORD','Proxy\x20listening\x20on\x20port:\x20','express','get_urdf_param','ROSBridge\x20WebSocket\x20URL:\x20','getAttribute','types','child_process','Successfully\x20registered\x20with\x20server','[URDF\x20REWRITE]\x20Rewrote\x20mesh\x20URI:\x20','existsSync','data','APP_USERNAME','(((.+)+)+)+$','Failed\x20to\x20get\x20registration\x20token\x20or\x20robot\x20id\x20from\x20server','11435767yDoSpL','EADDRINUSE','substring','/health','Failed\x20to\x20connect\x20to\x20server:','login','wsEndpoint','reason','log','slice','[MESH]\x20Error\x20serving\x20mesh:','discoverTopics','robot\x20not\x20found','writeFileSync','path','development','Production\x20mode:\x20Credentials\x20must\x20be\x20provided\x20in\x20.env\x20file','\x0aAPP_PASSWORD=','open','string','match','61562nHmoDZ','getTopicStrategy','action','Connected\x20to\x20ROSBridge\x20(main)','setAttribute','exit','header','readFileSync','close','Failed\x20to\x20bind\x20to\x20a\x20port\x20after\x20','Enter\x20username:\x20','getActiveSessions','throttling','sample','Failed\x20to\x20connect\x20to\x20ROSBridge\x20(main):','publish','WSL\x20Appliance','\x20from\x20','values','endsWith','serverUrl','Topic\x20discovery\x20failed:','dotenv','[URDF\x20REWRITE]\x20Rewrote\x20','.appliance.json','trim','Authentication\x20required','PORT','registrationToken','/ros/mesh?uri=','connection','get','listen','join','Failed\x20to\x20parse\x20appliance\x20identity\x20file:','ROSBridge\x20(main)\x20connection\x20error:','username','./config','Loaded\x20credentials:','registration_token','1059916JXmEFV','mesh_data','strategies','request_id','./services/auth','text/xml','utf8','map','Connected\x20to\x20server','NODE_ENV','credentials','axios','toString','Backend\x20Server\x20URL:\x20','toLowerCase','Not\x20authenticated','OPTIONS','base64','initialize','NOT\x20SET','post','isAuthenticated','getElementsByTagName','[TopicManager]\x20Enhanced\x20topics\x20response\x20sent\x20to\x20client','response','Attempting\x20to\x20login\x20to:','Port\x20','status','share','uri','service_response','Disconnected\x20from\x20server\x20(','Disconnected\x20from\x20ROSBridge\x20(WebRTC),\x20attempting\x20to\x20reconnect...','Environment:\x20','send','OPEN','readyState','totalTopics','Loaded\x20appliance\x20identity:','APPLIANCE_BASE_URL','getToken','service','13040RGteTk','Failed\x20to\x20connect\x20to\x20ROSBridge\x20(WebRTC):','129MojWXl','/appliance/register','stringify','),\x20attempting\x20to\x20reconnect...','Login\x20failed.\x20Please\x20enter\x20credentials\x20again.','constructor','robotId','topics','rosbridge','env','production','4112484MySBZe','webrtc_skip','.env','.ply','get_mesh','error','use','2982SpDwvE','Initial\x20credentials\x20loaded\x20from\x20environment','unknown','config','warn','Mesh\x20file\x20not\x20found:\x20','some','prompt-sync','stopAllSessions','Disconnected\x20from\x20ROSBridge\x20(main),\x20attempting\x20to\x20reconnect...','[URDF\x20REWRITE]\x20Failed\x20to\x20rewrite\x20mesh\x20URIs\x20in\x20URDF\x20(WebSocket):','msg','7936551DlAUZp','param_name','sample_skip','\x20of\x20','search','application/json','apply','[URDF]\x20Failed\x20to\x20rewrite\x20mesh\x20URIs:','/appliance/ping','topic','/rosapi/topics','catch','estimatedSize','parse','xmldom','replace','urdf_param_data','./services/webrtcService','Access-Control-Allow-Headers','parseFromString','.stl','name','length','call_service','Failed\x20to\x20register\x20with\x20server','Ros','includes','10595296yHoJLE','getSharedVideoSources','ROSBridge\x20(WebRTC)\x20connection\x20error:','startsWith','.mesh','password','Origin,\x20X-Requested-With,\x20Content-Type,\x20Accept,\x20Authorization','Failed\x20to\x20start\x20application:','.obj','message','SET','Please\x20run:\x20./setup.sh\x20reconfigure','[URDF\x20PARAM]\x20Error\x20fetching\x20URDF\x20parameter:','Bearer\x20','Appliance\x20server\x20started\x20successfully\x20on\x20port\x20','Access-Control-Allow-Origin','\x20attempts\x20starting\x20from\x20','unlinkSync','json','proxyPort'];a1_0x5692=function(){return _0x41ae6b;};return a1_0x5692();}async function promptForCredentials(){const _0x523341=a1_0x29ee9d;process[_0x523341(0xe0)][_0x523341(0xb4)]===_0x523341(0xe1)&&(console['error'](_0x523341(0x7e)),console['error'](_0x523341(0x11b)),process[_0x523341(0x88)](0x1));const _0x5a20c2=prompt(_0x523341(0x8d)),_0xccae2e=prompt['hide']('Enter\x20password:\x20');updateEnvFile(_0x5a20c2,_0xccae2e),reloadEnv();}function loadApplianceIdentity(){const _0x342892=a1_0x29ee9d;if(fs['existsSync'](APPLIANCE_FILE))try{const _0x43ed48=JSON[_0x342892(0x102)](fs[_0x342892(0x8a)](APPLIANCE_FILE,_0x342892(0xb1)));if(_0x43ed48['robotId']&&_0x43ed48[_0x342892(0x9f)])return robotId=_0x43ed48[_0x342892(0xdd)],registrationToken=_0x43ed48[_0x342892(0x9f)],console[_0x342892(0x76)](_0x342892(0xd1),robotId),topicManager['loadConfig'](_0x43ed48),!![];}catch(_0x23fe2e){console[_0x342892(0xe7)](_0x342892(0xa5),_0x23fe2e);}return![];}function saveApplianceIdentity(_0x35f664,_0x2328ab){const _0x2f6d2e=a1_0x29ee9d;let _0xd64a7b={};if(fs['existsSync'](APPLIANCE_FILE))try{_0xd64a7b=JSON[_0x2f6d2e(0x102)](fs['readFileSync'](APPLIANCE_FILE,_0x2f6d2e(0xb1)));}catch(_0x29816e){_0xd64a7b={};}_0xd64a7b[_0x2f6d2e(0xdd)]=_0x35f664,_0xd64a7b[_0x2f6d2e(0x9f)]=_0x2328ab,fs[_0x2f6d2e(0x7b)](APPLIANCE_FILE,JSON[_0x2f6d2e(0xd9)](_0xd64a7b,null,0x2));}async function registerWithServer(){const _0x6021f3=a1_0x29ee9d;try{const _0x40cd83=authService[_0x6021f3(0xd3)]();if(!_0x40cd83)throw new Error(_0x6021f3(0xba));let _0x28562,_0xc2b8aa=![];while(!![]){try{robotId&&registrationToken?_0x28562=await axios[_0x6021f3(0xbf)](config[_0x6021f3(0x97)]+'/appliance/register',{'name':_0x6021f3(0x93),'robotId':robotId,'registration_token':registrationToken},{'headers':{'Authorization':_0x6021f3(0x11d)+_0x40cd83,'Content-Type':'application/json'}}):_0x28562=await axios['post'](config[_0x6021f3(0x97)]+_0x6021f3(0xd8),{'name':'WSL\x20Appliance'},{'headers':{'Authorization':'Bearer\x20'+_0x40cd83,'Content-Type':_0x6021f3(0xfa)}});break;}catch(_0xa1fdbd){const _0x29faf9=_0xa1fdbd?.[_0x6021f3(0xc3)]?.[_0x6021f3(0x12f)]?.[_0x6021f3(0xe7)]||_0xa1fdbd['message'];if(!_0xc2b8aa&&_0x29faf9&&_0x29faf9[_0x6021f3(0xb9)]()[_0x6021f3(0x10f)](_0x6021f3(0x7a))){console['warn']('Robot\x20not\x20found\x20on\x20server.\x20Deleting\x20local\x20identity\x20and\x20re-registering.');if(fs[_0x6021f3(0x12e)](APPLIANCE_FILE))fs[_0x6021f3(0x121)](APPLIANCE_FILE);robotId=null,registrationToken=null,_0xc2b8aa=!![];continue;}throw _0xa1fdbd;}}if(!_0x28562['data']||!_0x28562['data'][_0x6021f3(0xaa)]||!_0x28562[_0x6021f3(0x12f)]['id'])throw new Error(_0x6021f3(0x6d));return registrationToken=_0x28562[_0x6021f3(0x12f)][_0x6021f3(0xaa)],robotId=_0x28562[_0x6021f3(0x12f)]['id'],saveApplianceIdentity(robotId,registrationToken),console[_0x6021f3(0x76)](_0x6021f3(0x12c)),!![];}catch(_0x5c0211){return console[_0x6021f3(0xe7)]('Failed\x20to\x20register\x20with\x20server:',_0x5c0211[_0x6021f3(0x119)]),![];}}function rewriteUrdfMeshUris(_0x5bde1c){const _0x575d2b=a1_0x29ee9d;try{const _0x4f0a97=new DOMParser(),_0x2755c2=_0x4f0a97[_0x575d2b(0x108)](_0x5bde1c,_0x575d2b(0xb0));let _0x21a8b4=0x0,_0x14554f=0x0;const _0x4f7a60=_0x2755c2[_0x575d2b(0xc1)]('mesh');for(let _0x1205b5=0x0;_0x1205b5<_0x4f7a60[_0x575d2b(0x10b)];_0x1205b5++){const _0x100d2c=_0x4f7a60[_0x1205b5],_0x3c8a90=_0x100d2c[_0x575d2b(0x129)]('filename'),_0x5863cf=[_0x575d2b(0x109),'.dae',_0x575d2b(0x118),_0x575d2b(0xe5),_0x575d2b(0x114)],_0x3f5239=_0x5863cf[_0x575d2b(0xef)](_0x5e6cac=>_0x3c8a90[_0x575d2b(0xb9)]()[_0x575d2b(0x96)](_0x5e6cac));if(_0x3c8a90&&_0x3c8a90[_0x575d2b(0x113)]('package://')&&_0x3f5239){_0x21a8b4++;const _0x527cab=APPLIANCE_BASE_URL+_0x575d2b(0xa0)+encodeURIComponent(_0x3c8a90);_0x100d2c[_0x575d2b(0x87)]('filename',_0x527cab),_0x14554f++,console[_0x575d2b(0x76)](_0x575d2b(0x12d)+_0x3c8a90+'\x20->\x20'+_0x527cab);}}_0x21a8b4>0x0?console[_0x575d2b(0x76)](_0x575d2b(0x9a)+_0x14554f+_0x575d2b(0xf8)+_0x21a8b4+'\x20mesh\x20references\x20in\x20URDF\x20(WebSocket)'):console['log']('[URDF\x20REWRITE]\x20No\x20mesh\x20references\x20found\x20in\x20URDF');const _0x36fbc3=new XMLSerializer();return _0x36fbc3['serializeToString'](_0x2755c2);}catch(_0xc38957){return console[_0x575d2b(0xe7)](_0x575d2b(0xf3),_0xc38957),_0x5bde1c;}}function connectToRosbridge(){const _0x5cb3e3=a1_0x29ee9d;try{rosbridgeWs=new WebSocket(config['rosbridge']['wsEndpoint']),rosbridgeWs['on']('open',()=>{const _0x342d51=a1_0x3c95;console[_0x342d51(0x76)](_0x342d51(0x86));const _0x5a886c=require('roslib'),_0xff5450=new _0x5a886c[(_0x342d51(0x10e))]({'url':config[_0x342d51(0xdf)][_0x342d51(0x74)]});_0xff5450['on'](_0x342d51(0xa1),()=>{setTimeout(()=>{const _0x183889=a1_0x3c95;topicManager[_0x183889(0x79)](_0xff5450)[_0x183889(0x100)](_0x56965b=>{const _0x56de23=_0x183889;console[_0x56de23(0xe7)](_0x56de23(0x98),_0x56965b);});},0x3e8);}),connectToRosbridgeWebRTC();}),rosbridgeWs['on'](_0x5cb3e3(0x119),_0x28b674=>{const _0x2db6a8=_0x5cb3e3;if(serverWs&&serverWs['readyState']===WebSocket[_0x2db6a8(0xce)]){let _0x3ff20f=_0x28b674['toString']();try{const _0x411b5a=JSON[_0x2db6a8(0x102)](_0x3ff20f);if(_0x411b5a['op']===_0x2db6a8(0x92)&&_0x411b5a[_0x2db6a8(0xfe)]){const _0xef0eb8=topicManager['handleMessage'](_0x411b5a);switch(_0xef0eb8[_0x2db6a8(0x85)]){case _0x2db6a8(0xf7):return;case _0x2db6a8(0xe3):return;case'forward':default:_0x3ff20f=JSON[_0x2db6a8(0xd9)](_0xef0eb8[_0x2db6a8(0x119)]);break;}}if((_0x411b5a['op']===_0x2db6a8(0xc9)||_0x411b5a['op']===_0x2db6a8(0x10c))&&(_0x411b5a[_0x2db6a8(0xd4)]===_0x2db6a8(0xff)||_0x411b5a['values']&&_0x411b5a[_0x2db6a8(0x95)][_0x2db6a8(0xde)])){console[_0x2db6a8(0x76)]('[TopicManager]\x20Enhancing\x20topics\x20response\x20with\x20throttling\x20metadata');const _0x35ebc0=_0x411b5a[_0x2db6a8(0x95)]?.[_0x2db6a8(0xde)]||[],_0x279eea=_0x411b5a[_0x2db6a8(0x95)]?.[_0x2db6a8(0x12a)]||[],_0xb97e7c=_0x35ebc0[_0x2db6a8(0xb2)]((_0x521943,_0x130f29)=>{const _0x2c12dc=_0x2db6a8,_0x387e63=topicManager[_0x2c12dc(0x84)](_0x521943);return{'name':_0x521943,'type':_0x279eea[_0x130f29]||_0x2c12dc(0xeb),'throttling':_0x387e63?{'isThrottled':_0x387e63['strategy']===_0x2c12dc(0x90),'strategy':_0x387e63['strategy'],'samplingRate':_0x387e63['samplingRate'],'reason':_0x387e63[_0x2c12dc(0x75)],'estimatedSize':_0x387e63[_0x2c12dc(0x101)]}:null};});_0x411b5a[_0x2db6a8(0x95)]={'topics':_0xb97e7c[_0x2db6a8(0xb2)](_0x58cdc1=>_0x58cdc1[_0x2db6a8(0x10a)]),'types':_0xb97e7c[_0x2db6a8(0xb2)](_0x2d339f=>_0x2d339f['type']),'throttling':_0xb97e7c[_0x2db6a8(0xb2)](_0x50997f=>_0x50997f[_0x2db6a8(0x8f)])},_0x3ff20f=JSON['stringify'](_0x411b5a),console[_0x2db6a8(0x76)](_0x2db6a8(0xc2));}if(_0x411b5a['op']===_0x2db6a8(0x92)&&_0x411b5a[_0x2db6a8(0xfe)]==='/robot_description')try{const _0x5efbb6=_0x411b5a[_0x2db6a8(0xf4)][_0x2db6a8(0x12f)],_0x21bce7=rewriteUrdfMeshUris(_0x5efbb6);_0x411b5a[_0x2db6a8(0xf4)]['data']=_0x21bce7,_0x3ff20f=JSON[_0x2db6a8(0xd9)](_0x411b5a);}catch(_0x36f63c){console['error'](_0x2db6a8(0xfc),_0x36f63c);}}catch(_0x46df41){console['warn']('[ROSBridge]\x20Failed\x20to\x20parse\x20message\x20for\x20topic\x20management:',_0x46df41['message']);}serverWs[_0x2db6a8(0xcd)](_0x3ff20f);}}),rosbridgeWs['on']('close',()=>{const _0x33420d=_0x5cb3e3;console[_0x33420d(0x76)](_0x33420d(0xf2)),webrtcService[_0x33420d(0xf1)](),setTimeout(connectToRosbridge,0x1388);}),rosbridgeWs['on']('error',_0x36d530=>{const _0x3d00ad=_0x5cb3e3;console[_0x3d00ad(0xe7)](_0x3d00ad(0xa6),_0x36d530);});}catch(_0xc1d674){console[_0x5cb3e3(0xe7)](_0x5cb3e3(0x91),_0xc1d674),setTimeout(connectToRosbridge,0x1388);}}function connectToRosbridgeWebRTC(){const _0x284572=a1_0x29ee9d;try{rosbridgeWebRTCWs=new WebSocket(config[_0x284572(0xdf)][_0x284572(0x74)]),rosbridgeWebRTCWs['on']('open',()=>{const _0x5509f3=_0x284572;console['log']('Connected\x20to\x20ROSBridge\x20(WebRTC)'),webrtcService[_0x5509f3(0xbd)](rosbridgeWebRTCWs,serverWs);}),rosbridgeWebRTCWs['on'](_0x284572(0x119),_0x4e674b=>{}),rosbridgeWebRTCWs['on'](_0x284572(0x8b),()=>{const _0x1a5a1f=_0x284572;console[_0x1a5a1f(0x76)](_0x1a5a1f(0xcb)),webrtcService['stopAllSessions'](),setTimeout(connectToRosbridgeWebRTC,0x1388);}),rosbridgeWebRTCWs['on']('error',_0x35ee44=>{const _0x4e721e=_0x284572;console[_0x4e721e(0xe7)](_0x4e721e(0x112),_0x35ee44);});}catch(_0xd8689){console['error'](_0x284572(0xd6),_0xd8689),setTimeout(connectToRosbridgeWebRTC,0x1388);}}function a1_0x3c95(_0x238069,_0x2dc64b){const _0x41ad83=a1_0x5692();return a1_0x3c95=function(_0x2435c6,_0x4d5fc8){_0x2435c6=_0x2435c6-0x6d;let _0x569230=_0x41ad83[_0x2435c6];return _0x569230;},a1_0x3c95(_0x238069,_0x2dc64b);}function connectToServer(){const _0x39b944=a1_0x29ee9d;try{if(!registrationToken)throw new Error('Registration\x20token\x20not\x20found.\x20Please\x20register\x20this\x20appliance\x20first.');const _0x1114f5=config[_0x39b944(0x97)][_0x39b944(0x104)]('http','ws')+'/rosbridge?type=appliance&token='+registrationToken;serverWs=new WebSocket(_0x1114f5),serverWs['on'](_0x39b944(0x80),()=>{const _0x11146b=_0x39b944;console['log'](_0x11146b(0xb3)),rosbridgeWebRTCWs&&rosbridgeWebRTCWs[_0x11146b(0xcf)]===WebSocket['OPEN']&&webrtcService['initialize'](rosbridgeWebRTCWs,serverWs);}),serverWs['on'](_0x39b944(0x119),_0x2ee16d=>{const _0x58f60a=_0x39b944;if(rosbridgeWs&&rosbridgeWs['readyState']===WebSocket[_0x58f60a(0xce)]){let _0x1e9b02=_0x2ee16d[_0x58f60a(0xb7)]();try{const _0x208f81=JSON['parse'](_0x1e9b02);if(webrtcService['handleMessage'](_0x208f81))return;if(_0x208f81['op']===_0x58f60a(0x127)&&typeof _0x208f81[_0x58f60a(0xf6)]===_0x58f60a(0x81)&&_0x208f81['request_id'])try{console['log']('[URDF\x20PARAM]\x20Fetching\x20URDF\x20from\x20parameter:\x20'+_0x208f81[_0x58f60a(0xf6)]);const _0xafe526=execSync('ros2\x20param\x20get\x20'+_0x208f81[_0x58f60a(0xf6)],{'encoding':_0x58f60a(0xb1)})['trim']();let _0x226608=_0xafe526;_0xafe526[_0x58f60a(0x113)]('String\x20value\x20is:\x20')&&(_0x226608=_0xafe526[_0x58f60a(0x70)]('String\x20value\x20is:\x20'[_0x58f60a(0x10b)]()));_0x226608[_0x58f60a(0x113)]('\x22')&&_0x226608[_0x58f60a(0x96)]('\x22')&&(_0x226608=_0x226608[_0x58f60a(0x77)](0x1,-0x1));_0x226608=_0x226608[_0x58f60a(0x104)](/\\n/g,'\x0a')['replace'](/\\"/g,'\x22');const _0x53b438={'op':_0x58f60a(0x105),'request_id':_0x208f81[_0x58f60a(0xae)],'data':_0x226608};serverWs[_0x58f60a(0xcd)](JSON[_0x58f60a(0xd9)](_0x53b438)),console['log']('[URDF\x20PARAM]\x20Successfully\x20served\x20URDF\x20parameter:\x20'+_0x208f81['param_name']);return;}catch(_0x45b6ba){console[_0x58f60a(0xe7)](_0x58f60a(0x11c),_0x45b6ba);const _0x3a942f={'op':_0x58f60a(0x105),'request_id':_0x208f81['request_id'],'error':_0x45b6ba['message']};serverWs['send'](JSON[_0x58f60a(0xd9)](_0x3a942f));return;}if(_0x208f81['op']===_0x58f60a(0xe6)&&typeof _0x208f81[_0x58f60a(0xc8)]===_0x58f60a(0x81)&&_0x208f81[_0x58f60a(0xae)])try{const _0x5199db=_0x208f81[_0x58f60a(0xc8)][_0x58f60a(0x82)](/^package:\/\/([^\/]+)\/(.+)$/);if(_0x5199db){const _0x5e3576=_0x5199db[0x1],_0x478c6f=_0x5199db[0x2],_0x1ca752=execSync('ros2\x20pkg\x20prefix\x20'+_0x5e3576,{'encoding':'utf8'})[_0x58f60a(0x9c)](),_0x2b9296=path[_0x58f60a(0xa4)](_0x1ca752,_0x58f60a(0xc7),_0x5e3576,_0x478c6f);if(!fs['existsSync'](_0x2b9296))throw new Error(_0x58f60a(0xee)+_0x2b9296);const _0x41c4fd=fs['readFileSync'](_0x2b9296),_0x2b8b4e={'op':_0x58f60a(0xac),'request_id':_0x208f81['request_id'],'data':_0x41c4fd['toString'](_0x58f60a(0xbc))};serverWs[_0x58f60a(0xcd)](JSON['stringify'](_0x2b8b4e)),console[_0x58f60a(0x76)]('[MESH]\x20Successfully\x20served\x20mesh:\x20'+_0x208f81[_0x58f60a(0xc8)]+_0x58f60a(0x94)+_0x2b9296);return;}}catch(_0x5b8a50){console[_0x58f60a(0xe7)](_0x58f60a(0x78),_0x5b8a50);const _0x244469={'op':_0x58f60a(0xac),'request_id':_0x208f81[_0x58f60a(0xae)],'error':_0x5b8a50['message']};serverWs[_0x58f60a(0xcd)](JSON[_0x58f60a(0xd9)](_0x244469));return;}rosbridgeWs[_0x58f60a(0xcd)](_0x1e9b02);}catch(_0x3bdba4){rosbridgeWs['send'](_0x1e9b02);}}}),serverWs['on'](_0x39b944(0x8b),(_0x144e10,_0x369e44)=>{const _0x45a731=_0x39b944;console[_0x45a731(0x76)](_0x45a731(0xca)+_0x144e10+':\x20'+_0x369e44+_0x45a731(0xda)),webrtcService[_0x45a731(0xf1)](),setTimeout(connectToServer,0x1388);}),serverWs['on'](_0x39b944(0xe7),_0x1f2c01=>{console['error']('Server\x20connection\x20error:',_0x1f2c01);});}catch(_0x26fd02){console[_0x39b944(0xe7)](_0x39b944(0x72),_0x26fd02),setTimeout(connectToServer,0x1388);}}const requireAuth=async(_0x54d645,_0x1659fd,_0xb00baf)=>{const _0x4e873f=a1_0x29ee9d;if(!authService[_0x4e873f(0xc0)]()){console[_0x4e873f(0x76)](_0x4e873f(0xc4),config[_0x4e873f(0x97)]);const _0x88e8a4=await authService['login']();if(!_0x88e8a4)return _0x1659fd[_0x4e873f(0xc6)](0x191)[_0x4e873f(0x122)]({'error':_0x4e873f(0x9d)});}_0xb00baf();};app[a1_0x29ee9d(0xe8)]((_0x4a995c,_0x2107fd,_0x4cefd9)=>{const _0x15309a=a1_0x29ee9d;_0x2107fd[_0x15309a(0x89)](_0x15309a(0x11f),'*'),_0x2107fd[_0x15309a(0x89)]('Access-Control-Allow-Methods','GET,\x20POST,\x20PUT,\x20DELETE,\x20OPTIONS'),_0x2107fd[_0x15309a(0x89)](_0x15309a(0x107),_0x15309a(0x116)),_0x4a995c['method']===_0x15309a(0xbb)?_0x2107fd['sendStatus'](0xc8):_0x4cefd9();}),app[a1_0x29ee9d(0xa2)]('/',requireAuth,(_0x31fbcb,_0x291b43)=>{const _0xde545c=a1_0x29ee9d;_0x291b43[_0xde545c(0xcd)]('Appliance\x20is\x20running\x20and\x20authenticated!');}),app[a1_0x29ee9d(0xa2)](a1_0x29ee9d(0x71),async(_0x165593,_0x41ee43)=>{const _0x4e9eec=a1_0x29ee9d,_0x509d39=authService[_0x4e9eec(0xc0)](),_0x1109ae=webrtcService[_0x4e9eec(0x8e)](),_0x337516=webrtcService[_0x4e9eec(0x111)](),_0x35b714=topicManager['getStatistics']();_0x41ee43[_0x4e9eec(0x122)]({'status':'ok','environment':process[_0x4e9eec(0xe0)]['NODE_ENV']||_0x4e9eec(0x7d),'backendUrl':config[_0x4e9eec(0x97)],'rosbridgeUrl':config[_0x4e9eec(0xdf)][_0x4e9eec(0x74)],'proxyPort':port,'authenticated':_0x509d39,'topicManagement':{'discovered':_0x35b714[_0x4e9eec(0xd0)],'strategies':_0x35b714[_0x4e9eec(0xad)],'largeDataTopics':_0x35b714['largeDataTopics'][_0x4e9eec(0x10b)],'largeTopicsList':_0x35b714['largeDataTopics']},'webrtc':{'activeSessions':_0x1109ae[_0x4e9eec(0x10b)],'sharedVideoSources':_0x337516[_0x4e9eec(0x10b)],'sessions':_0x1109ae,'sharedSources':_0x337516}});});const getInitialPort=()=>{const _0x512098=a1_0x29ee9d;if(process[_0x512098(0xe0)]['PORT'])return parseInt(process[_0x512098(0xe0)][_0x512098(0x9e)],0xa);return config[_0x512098(0xdf)]['proxyPort'];};async function listenWithRetries(_0x2b82c9,_0x4e3905,_0x3d5345=0xa){const _0x180a1f=a1_0x29ee9d;let _0x1e39c4=_0x4e3905;for(let _0x3641c8=0x1;_0x3641c8<=_0x3d5345;_0x3641c8++){try{return await new Promise((_0x3412a6,_0x5ca589)=>{const _0x1f2fa5=a1_0x3c95,_0x2c12d4=_0x2b82c9[_0x1f2fa5(0xa3)](_0x1e39c4,()=>{const _0x46d969=_0x1f2fa5;console[_0x46d969(0x76)](_0x46d969(0x11e)+_0x1e39c4),_0x3412a6(_0x2c12d4);});_0x2c12d4['on'](_0x1f2fa5(0xe7),_0x2d6fdd=>{const _0xcfe0ac=_0x1f2fa5;_0x2d6fdd['code']===_0xcfe0ac(0x6f)?(console[_0xcfe0ac(0xed)](_0xcfe0ac(0xc5)+_0x1e39c4+'\x20in\x20use,\x20trying\x20next\x20port...'),_0x5ca589(_0x2d6fdd)):_0x5ca589(_0x2d6fdd);});}),_0x1e39c4;}catch(_0x2b4c17){_0x1e39c4++;}}throw new Error(_0x180a1f(0x8c)+_0x3d5345+_0x180a1f(0x120)+_0x4e3905);}const startApp=async()=>{const _0x4686ae=a1_0x29ee9d;try{reloadEnv();let _0x583879=await authService[_0x4686ae(0x73)]();while(!_0x583879){console[_0x4686ae(0x76)](_0x4686ae(0xdb)),await promptForCredentials(),_0x583879=await authService['login']();}console['log']('Successfully\x20logged\x20in');!loadApplianceIdentity()&&console[_0x4686ae(0x76)]('No\x20appliance\x20identity\x20found.\x20Registering\x20as\x20new.');console[_0x4686ae(0x76)]('Registering\x20with\x20server...');const _0x2349a5=await registerWithServer();if(!_0x2349a5)throw new Error(_0x4686ae(0x10d));connectToRosbridge(),connectToServer();const _0x4e2880=getInitialPort();await listenWithRetries(app,_0x4e2880,0xa);}catch(_0x259224){console[_0x4686ae(0xe7)](_0x4686ae(0x117),_0x259224),process[_0x4686ae(0x88)](0x1);}};setInterval(async()=>{const _0x42f633=a1_0x29ee9d;try{if(robotId){const _0x1bddae=authService[_0x42f633(0xd3)]();await axios[_0x42f633(0xbf)](config[_0x42f633(0x97)]+_0x42f633(0xfd),{'robotId':robotId},{'headers':{'Authorization':_0x42f633(0x11d)+_0x1bddae,'Content-Type':'application/json'}});}}catch(_0x40cf63){console[_0x42f633(0xe7)]('Failed\x20to\x20ping\x20server:',_0x40cf63[_0x42f633(0x119)]);}},0x1388),startApp();